# 要件ドキュメント

## はじめに

この機能は、Ruby LSP Mongoidアドオンを改善し、Mongoid DSLから動的に生成されるメソッドに対して正確なメソッドシグネチャを提供します。現在のインデックス強化機能は、最小限のシグネチャ情報のみでメソッドを登録しています。この改善により、適切なパラメータ情報、正確なソース位置追跡を提供し、オートコンプリート、ホバー情報、定義へジャンプなどのIDE機能をより良くサポートします。

## 用語集

- **メソッドシグネチャ（Method Signature）**: メソッドの名前、パラメータ（必須、オプション、キーワード、ブロック）、戻り値型情報の組み合わせ
- **DSL（Domain Specific Language）**: フィールド、関連、スコープを定義するためのMongoidの宣言的構文
- **インデックス強化（Indexing Enhancement）**: DSL呼び出しをパースし、生成されたメソッドをインデックスに登録するRuby LSPコンポーネント
- **パラメータタイプ**: 必須パラメータ、オプションパラメータ、キーワードパラメータ、restパラメータ、ブロックパラメータ
- **位置（Location）**: メソッドが定義されているファイルパスと行/列位置
- **遅延シグネチャ取得**: インデックス完了後にMongoidモジュールからシグネチャを取得して更新する戦略

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、Mongoidが生成したメソッドの正確なパラメータ情報を見たいです。そうすることで、オートコンプリートとホバー機能を効果的に使用できます。

#### 受け入れ条件

1. WHEN field DSLがアクセサメソッドを生成する場合 THEN IndexingEnhancement SHALL readerメソッドは空のパラメータシグネチャで、writerメソッドは単一の必須パラメータで登録する必要がある
2. WHEN has_manyまたはhas_and_belongs_to_many DSLがメソッドを生成する場合 THEN IndexingEnhancement SHALL コレクションreaderは空のパラメータで、コレクションwriterは必須パラメータで、_idsアクセサメソッドは適切なシグネチャで登録する必要がある
3. WHEN has_one、belongs_to、またはembeds_one DSLがメソッドを生成する場合 THEN IndexingEnhancement SHALL readerは空のパラメータで、writerは必須パラメータで、builderメソッドはオプションのattributesパラメータで登録する必要がある
4. WHEN scope DSLがクラスメソッドを生成する場合 THEN IndexingEnhancement SHALL lambda/proc定義から抽出したパラメータでメソッドを登録する必要がある

### 要件2

**ユーザーストーリー:** 開発者として、コアMongoid::Documentインスタンスメソッドが正確なシグネチャを持つことを望みます。そうすることで、永続化と状態確認メソッド使用時に正しいパラメータを見ることができます。

#### 受け入れ条件

1. WHEN Ruby LSPインデックスが完了した後 THEN Addon SHALL Mongoidモジュールからインスタンスメソッドシグネチャを取得して登録されたメソッドを更新する必要がある
2. WHEN インスタンスメソッドシグネチャが更新される場合 THEN シグネチャはMongoidの実際のメソッドパラメータ（必須、オプション、キーワードなど）を正確に反映する必要がある
3. WHEN Mongoidモジュールでメソッドシグネチャが見つからない場合 THEN そのメソッドは空のシグネチャを維持する必要がある

### 要件3

**ユーザーストーリー:** 開発者として、コアMongoid::Documentクラスメソッドが正確なシグネチャを持つことを望みます。そうすることで、クエリと作成メソッド使用時に正しいパラメータを見ることができます。

#### 受け入れ条件

1. WHEN Ruby LSPインデックスが完了した後 THEN Addon SHALL Mongoidモジュールからクラスメソッドシグネチャを取得して登録されたメソッドを更新する必要がある
2. WHEN クラスメソッドシグネチャが更新される場合 THEN シグネチャはMongoidの実際のメソッドパラメータ（必須、オプション）を正確に反映する必要がある
3. WHEN Mongoidモジュールでメソッドシグネチャが見つからない場合 THEN そのメソッドは空のシグネチャを維持する必要がある

### 要件4

**ユーザーストーリー:** 開発者として、メソッド位置情報がDSL宣言を正確に指すことを望みます。そうすることで、定義へジャンプが正しいソース行に移動します。

#### 受け入れ条件

1. WHEN DSLメソッドがインデックス化される場合 THEN IndexingEnhancement SHALL DSL呼び出しの正確な行と列をメソッドの定義位置として保存する必要がある
2. WHEN 単一のDSL呼び出しから複数のメソッドが生成される場合 THEN IndexingEnhancement SHALL 生成されたすべてのメソッドに同じ位置を割り当てる必要がある
3. WHEN インデックスを通じてメソッドがresolveされる場合 THEN 位置はDSL宣言と一致する正しいファイルURIと行番号を含む必要がある

### 要件5

**ユーザーストーリー:** 開発者として、ホバーツールチップでメソッドシグネチャ情報を見たいです。そうすることで、ドキュメントを参照せずに生成されたメソッドの呼び出し方を理解できます。

#### 受け入れ条件

1. WHEN 生成されたメソッド上でホバーする場合 THEN HoverProvider SHALL パラメータ名とタイプを含むメソッドシグネチャを表示する必要がある
2. WHEN fieldアクセサ上でホバーする場合 THEN HoverProvider SHALL シグネチャと共にフィールドオプション（type、default、alias）を表示する必要がある
3. WHEN associationメソッド上でホバーする場合 THEN HoverProvider SHALL ターゲットクラスと使用可能なパラメータを表示する必要がある
